# @groton/knowledgebase.router

Serve a Google-authenticated web site hosted in Google Cloud Storage from Google App Engine

# Install

For now, follow steps for [installing the monorepo]('../..#install'), including especially storing the web application OAuth 2.0 credentials in `var/keys.json`

# Configure

The configuration for this app is stored in `var/config.json` which is uploaded to GAE as part of the runtime (so changes made to the config need to be deployed).

```json
{
  "hostname": "subdomain.example.com",
  "session": { "secret": "185f3c79-4208-446f-9e66-322f68fe17c1" },
  "storage": { "bucket": "elderberry-fossil-098765" },
  "kb": {
    "root": "docs",
    "search": { "include": ["docs"], "exclude": ["assets"] }
  }
}
```

In addition, this app depends on the `var/index.json` and `var/groups.json` files generated by [`indexer`]('../indexer') and on the downloaded `var/keys.json` file (part of the [install](#install) process.)

### `hostname`

Optional. If a custom domain is mapped to the GAE project, set this property to ensure that the user _stays_ in the custom domain (and their session is continuous) throughout the login process.

### `session.secret`

Required. A secret used to encrypt session data at rest in Firestore.

### `storage.bucket`

Required. The ID of the GCS bucket where the static content is stored.

### `kb.root`

Optional. Relative path from root of GCS bucket to the root of the documents folder. `/` will be redirected to this path in the location bar if defined (otherwise `/` will be processed as an index of the GCS bucket, as would any other directory path)

### `kb.search`

Inclusions are processed before exclusions. So if you wanted to include `docs` but exclude `docs/secrets`, that would work.

##### `kb.search.include`

Optional. An array of paths to be included in search responses (if the user has access to them).

##### `kb.search.exclude`

Optional. An array of paths to be excluded in search responses (no matter what the user's level of access is).

# Build

```sh
pnpm -F @groton/knowledgebase.router run build
```

The build script for this app currently assumes that [`ui`](../ui) is also present, and depends on its build output.

# Deploy

```sh
pnpm -F @groton/knowledgebase.router run deploy
```

To improve the efficiency of the GAE deployment, part of the deploy process includes generating a temporary, optimized, package-only lockfile for `router`. `gcloud app deploy` will generate errors, as the GAE build process will (slowly) reify its own lockfile of dependencies and be unable to find the local packages that exist only in this mono repo in [`../packages`](../packages).
